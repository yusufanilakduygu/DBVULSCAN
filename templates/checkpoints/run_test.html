{% extends "layout.html" %}
{% block title %}Run Test · {{ checkpoint.name }}{% endblock %}

{% block content %}
<style>
.rt-wrap{
    background:#fff;
    border:1px solid #e5e9f2;
    border-radius:12px;
    padding:16px;
    max-width:1100px;
    margin:auto;
}
.rt-header{margin-bottom:16px;}
.rt-header h3{font-weight:800;margin:0 0 6px 0;}
.rt-meta{font-size:13px;color:#555;}
.rt-section{margin-top:18px;}
.rt-section h4{font-size:14px;font-weight:700;margin-bottom:6px;}
.rt-sql-box{
    border:1px solid #e5e9f2;
    border-radius:8px;
    background:#f9fafb;
    padding:8px 10px;
    font-family:monospace;
    font-size:13px;
    white-space:pre-wrap;
}
.rt-condition{font-size:13px;color:#555;margin-top:6px;}
.rt-select{
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #e5e9f2;
    font-size:14px;
    margin-top:6px;
}
.rt-actions{margin-top:16px;display:flex;gap:10px;}
.btn-rt{padding:8px 16px;border-radius:8px;border:1px solid #d0d7e2;background:#fff;cursor:pointer;font-size:14px;text-decoration:none;}
.btn-rt-primary{background:#2563eb;color:#fff;border-color:#1d4ed8;}
.btn-rt-primary:hover{background:#1d4ed8;}
.btn-rt-secondary:hover{background:#f3f4f6;}
.rt-result{margin-top:18px;padding:10px 12px;border-radius:8px;font-size:13px;}
.rt-result.pass{background:#ecfdf3;border:1px solid #bbf7d0;color:#166534;}
.rt-result.fail{background:#fef2f2;border:1px solid #fecaca;color:#b91c1c;}
.rt-result.info{background:#eff6ff;border:1px solid #bfdbfe;color:#1d4ed8;}
.rt-result.error{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;}
</style>

<div class="rt-wrap">
  <div class="rt-header">
    <h3>Run Test – {{ checkpoint.name }}</h3>
    <div class="rt-meta">
      DB Type: <strong>{{ checkpoint.db_type }}</strong> ·
      Severity: <strong>{{ checkpoint.severity }}</strong>
    </div>
  </div>

  <!-- Pre SQL Test -->
  <div class="rt-section">
    <h4>Pre SQL Test</h4>
    {% if checkpoint.pre_sql_test %}
      <div class="rt-sql-box">{{ checkpoint.pre_sql_test }}</div>
    {% else %}
      <div style="font-size:13px;color:#777;">No Pre SQL Test defined.</div>
    {% endif %}
  </div>

  <!-- SQL Test -->
  <div class="rt-section">
    <h4>SQL Test</h4>
    <div class="rt-sql-box">{{ checkpoint.sql_test }}</div>
    <div class="rt-condition">
      Condition:
      {% if checkpoint.test_condition %}
        <code>{{ checkpoint.test_condition }}</code>
      {% else %}
        <span style="color:#999;">(no condition defined)</span>
      {% endif %}
    </div>
  </div>

  <!-- Datasource select -->
  <div class="rt-section">
    <h4>Choose Datasource ({{ checkpoint.db_type }})</h4>

    {% if datasources %}
      <form method="post">
        <select name="datasource_id" class="rt-select">
          <option value="">-- Select datasource --</option>
          {% for ds in datasources %}
          <option value="{{ ds.id }}"
            {% if selected_ds and selected_ds.id == ds.id %}selected{% endif %}>
            {{ ds.name }} ({{ ds.host }}:{{ ds.port }})
            {% if ds.database_name %} · DB: {{ ds.database_name }}{% endif %}
            {% if ds.oracle_service_name %} · Service: {{ ds.oracle_service_name }}{% endif %}
            {% if ds.oracle_sid %} · SID: {{ ds.oracle_sid }}{% endif %}
          </option>
          {% endfor %}
        </select>

        <div class="rt-actions">
          <button type="submit" class="btn-rt btn-rt-primary">Run Test</button>
          <a href="{{ url_for('checkpoints.edit_checkpoint', checkpoint_id=checkpoint.id) }}"
             class="btn-rt btn-rt-secondary">Back to Checkpoint</a>
        </div>
      </form>
    {% else %}
      <p style="font-size:13px;color:#666;">
        No datasource defined for this DB Type. Please create one in the Datasources screen first.
      </p>
      <div class="rt-actions">
        <a href="{{ url_for('checkpoints.edit_checkpoint', checkpoint_id=checkpoint.id) }}"
           class="btn-rt btn-rt-secondary">Back to Checkpoint</a>
      </div>
    {% endif %}
  </div>

  <!-- Result -->
  {% if status or error_message %}
    {% if status == 'PASS' %}
      <div class="rt-result pass">
        <strong>Result: PASS</strong><br>
        Value: <code>{{ result_value }}</code><br>
        {% if condition_expr %}
          Condition: <code>{{ condition_expr }}</code>
        {% endif %}
      </div>
    {% elif status == 'FAIL' %}
      <div class="rt-result fail">
        <strong>Result: FAIL</strong><br>
        Value: <code>{{ result_value }}</code><br>
        {% if condition_expr %}
          Condition: <code>{{ condition_expr }}</code>
        {% endif %}
      </div>
    {% elif status == 'NO_CONDITION' %}
      <div class="rt-result info">
        <strong>No condition defined.</strong><br>
        Value: <code>{{ result_value }}</code>
      </div>
    {% elif status == 'ERROR' %}
      <div class="rt-result error">
        <strong>Result: ERROR</strong><br>
        <span style="font-size:13px; white-space:pre-wrap;">
          {{ error_message }}
        </span>
      </div>
    {% endif %}
  {% endif %}
</div>

{% endblock %}
