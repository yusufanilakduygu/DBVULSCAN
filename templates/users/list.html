{% extends "layout.html" %}
{% block title %}Users Â· DB Vulnerability Scan{% endblock %}

{% block content %}
<style>
.ds-wrap{background:#fff;border:1px solid #e5e9f2;border-radius:12px;}
.ds-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #e5e9f2;flex-wrap:wrap;gap:8px}
.ds-title{font-weight:800}
.ds-actions a.btn{display:inline-block;padding:8px 12px;border-radius:8px;text-decoration:none}
.btn-primary{background:#2563eb;color:#fff;border:1px solid #1d4ed8}
.btn-primary:hover{background:#1d4ed8}
.badge{display:inline-block;padding:2px 8px;border:1px solid #e5e9f2;border-radius:999px;background:#fff;font-size:12px}
.ds-table{width:100%;border-collapse:collapse}
.ds-table th,.ds-table td{padding:10px 12px;border-top:1px solid #eef2f7;text-align:left;vertical-align:middle}
.ds-table thead th{background:#f8fafc;font-weight:700;border-top:none}
.actions a,.actions button{display:inline-block;padding:6px 10px;border-radius:8px;font-size:13px;text-decoration:none;cursor:pointer;border:1px solid #e5e9f2;background:#fff}
.actions a:hover,.actions button:hover{background:#f8fafc}
.actions .danger{border-color:#fecaca;color:#7f1d1d;background:#fff}
.actions .danger:hover{background:#fff1f2}
.search-box{display:flex;align-items:center;gap:6px}
.search-box input{border:1px solid #e5e9f2;border-radius:8px;padding:6px 10px;width:220px}
@media (max-width: 980px){ .ds-head{flex-direction:column;align-items:flex-start} }
</style>

<div class="ds-wrap">
  <div class="ds-head">
    <div class="ds-title">Users</div>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search users..." onkeyup="filterTable()">
    </div>

    <div class="ds-actions">
      {% if current_role != 'viewer' %}
      <a href="{{ url_for('users.create_user') }}" class="btn btn-primary">New User</a>
      {% else %}
      <span class="badge">Viewer mode</span>
      {% endif %}
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="ds-table" id="userTable">
      <thead>
        <tr>
          <th>Username</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          {% if current_role != 'viewer' %}<th style="width:200px">Actions</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr>
          <td>{{ u.username }}</td>
          <td>{{ u.full_name }}</td>
          <td>{{ u.email }}</td>
          <td><span class="badge">{{ u.role }}</span></td>
          <td>
            {% if u.active %}
              <span class="badge" style="border-color:#bbf7d0;background:#f0fdf4;">Active</span>
            {% else %}
              <span class="badge" style="border-color:#fecaca;background:#fef2f2;">Inactive</span>
            {% endif %}
          </td>
          {% if current_role != 'viewer' %}
          <td class="actions">
            <a href="{{ url_for('users.edit_user', user_id=u.user_id) }}">Edit</a>
            <form action="{{ url_for('users.delete_user', user_id=u.user_id) }}"
                  method="post" style="display:inline"
                  onsubmit="return confirm('Delete {{ u.username }}?');">
              <button class="danger" type="submit">Delete</button>
            </form>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
function filterTable() {
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const table = document.getElementById("userTable");
  const rows = table.getElementsByTagName("tr");

  for (let i = 1; i < rows.length; i++) {
    let visible = false;
    const cells = rows[i].getElementsByTagName("td");
    for (let j = 0; j < cells.length; j++) {
      const text = cells[j].textContent || cells[j].innerText;
      if (text.toLowerCase().includes(filter)) {
        visible = true;
        break;
      }
    }
    rows[i].style.display = visible ? "" : "none";
  }
}
</script>
{% endblock %}
